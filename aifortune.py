# -*- coding: utf-8 -*-
"""AIç®—å‘½å¸«ç³»çµ±.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jzcMrjjm6ZB8ApJ_heStpaa3sPIWFV2L

**AIç®—å‘½å¸«ç³»çµ±**  
èªªæ˜: RAG + Groq å¦è±¡å•ç­”ç³»çµ± åŠ ä¸Šã€Œéš¨æ©Ÿèµ·å¦ã€åŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…åªè¼¸å…¥ä¸€å€‹å•é¡Œï¼Œç³»çµ±æœƒ:

1. éš¨æ©Ÿç”¢ç”Ÿå¦è±¡ï¼ˆ6 å€‹çˆ»ï¼Œæ¯å€‹çˆ»å¯èƒ½è®Šå‹•ï¼‰

2. æ‰¾å‡ºå¦è±¡èˆ‡å‹•çˆ»

3. æ•´åˆé€² prompt â†’ ä¸Ÿçµ¦æ¨¡å‹ç”Ÿæˆå›ç­”

**èµ·å¦æ–¹å¼ï¼ˆéš¨æ©Ÿæ³•ï¼‰èªªæ˜**  

æ¯ä¸€çˆ»æœƒæ˜¯ä»¥ä¸‹å››ç¨®ä¹‹ä¸€ï¼ˆéŠ…éŒ¢æ³•è½‰æ›ï¼‰ï¼š

6ï¼šé™°çˆ»è®Šï¼ˆâš‹ â†’ âšŠï¼‰

7ï¼šé™½çˆ»ä¸è®Šï¼ˆâšŠï¼‰

8ï¼šé™°çˆ»ä¸è®Šï¼ˆâš‹ï¼‰

9ï¼šé™½çˆ»è®Šï¼ˆâšŠ â†’ âš‹ï¼‰

**å¯è‡ªè¡Œä¸‹è¼‰è³‡æ–™æª”**
"""

!wget -O yijing_data.jsonl "https://drive.google.com/file/d/1wXqcyUDpkgk9ycdJFwV9bOMki9NEutyI/view?usp=sharing"

"""**è¼‰å…¥å¿…è¦å¥—ä»¶**"""

!pip install gradio

!pip install faiss-cpu
!pip install sentence-transformers
!pip install openai

import random
import json
import faiss
import numpy as np
import requests
import gradio as gr
from sentence_transformers import SentenceTransformer

"""**åˆå§‹åŒ–æ¨¡å‹èˆ‡è³‡æ–™**"""

GROQ_API_KEY = "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"
data_path = "/content/yijing_training_data_3000.jsonl"

"""**è¼‰å…¥ JSONL è³‡æ–™**"""

sample_data = []
with open(data_path, 'r', encoding='utf-8') as f:
    for line in f:
        item = json.loads(line)
        if "prompt" in item and "completion" in item:
            sample_data.append(item)

corpus = [item["prompt"] for item in sample_data]

"""**åµŒå…¥æ¨¡å‹èˆ‡å‘é‡è³‡æ–™åº«**"""

embed_model = SentenceTransformer("all-MiniLM-L6-v2")
embeddings = embed_model.encode(corpus, convert_to_numpy=True)
dimension = embeddings.shape[1]
index = faiss.IndexFlatL2(dimension)
index.add(embeddings)

"""**éš¨æ©Ÿèµ·æ›**"""

yao_map = {
    6: "é™°çˆ»è®Š",
    7: "é™½çˆ»ä¸è®Š",
    8: "é™°çˆ»ä¸è®Š",
    9: "é™½çˆ»è®Š"
}

def random_hexagram():
    yaos = [random.choice([6, 7, 8, 9]) for _ in range(6)]
    yao_desc = [yao_map[y] for y in yaos]
    return yaos, yao_desc

"""**æŸ¥è©¢èªæ–™åº«**"""

def retrieve_context(query, top_k=3):
    query_embedding = embed_model.encode([query], convert_to_numpy=True)
    D, I = index.search(query_embedding, top_k)
    return "\n\n".join([sample_data[i]["completion"] for i in I[0]])

"""**å‘¼å« Groq**"""

def ask_llm(query, context):
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": "llama3-8b-8192",
        "messages": [
            {
                "role": "system",
                "content": "ä½ å…¨ç¨‹åªæœƒä½¿ç”¨ä¸­æ–‡å›ç­”ï¼Œä¸”ä½ æ˜¯ä¸€ä½æ“…é•·è§£é‡‹æ˜“ç¶“å¦è±¡çš„æ™ºæ…§é¡§å•ï¼Œæ ¹æ“šå¦è±¡èˆ‡ä½¿ç”¨è€…å•é¡Œï¼Œçµ¦å‡ºæœ‰æ·±åº¦çš„å»ºè­°ã€‚"
            },
            {
                "role": "user",
                "content": f"èƒŒæ™¯è³‡æ–™å¦‚ä¸‹ï¼š\n{context}\n\nä½¿ç”¨è€…æå•ï¼š{query}"
            }
        ],
        "temperature": 0.7,
        "max_tokens": 512
    }

    response = requests.post("https://api.groq.com/openai/v1/chat/completions",
                             headers=headers, json=payload)
    try:
        return response.json()["choices"][0]["message"]["content"]
    except Exception as e:
        return f"âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š{response.text}"

"""**ä¸»é‚è¼¯**"""

def fortune_teller(user_question):
    yaos, yao_desc = random_hexagram()
    moving_lines = [i+1 for i, y in enumerate(yaos) if y in [6, 9]]
    yao_text = f"å‹•çˆ»ï¼š{', '.join(map(str, moving_lines)) if moving_lines else 'ç„¡'}\nå…­çˆ»ç‹€æ…‹ï¼š{', '.join(yao_desc)}"

    # çµ„åˆ Promptï¼ˆæ¨¡æ“¬ä½¿ç”¨è€…åŸæœ¬æ‰‹å‹•æä¾›å¦è±¡ï¼‰
    pseudo_prompt = f"å•é¡Œï¼š{user_question}\nå¦è±¡ï¼šéš¨æ©Ÿå¦è±¡ï¼Œ{yao_text}ã€‚\n"

    # åš RAG
    context = retrieve_context(pseudo_prompt)
    answer = ask_llm(pseudo_prompt, context)

    return f"ğŸ”® æ‚¨çš„å•é¡Œï¼š{user_question}\n\nğŸ§§ æ‚¨æŠ½åˆ°çš„å¦è±¡æè¿°ï¼š\n{yao_text}\n\nğŸ’¡ è§£å¦å»ºè­°ï¼š\n{answer}"

"""**Gradio UI**"""

gr.Interface(
    fn=fortune_teller,
    inputs=gr.Textbox(lines=2, label="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ", placeholder="ä¾‹å¦‚ï¼šæˆ‘æœ€è¿‘é©åˆæ›å·¥ä½œå—ï¼Ÿ"),
    outputs=gr.Textbox(label="å¦è±¡è§£é‡‹çµæœ"),
    title="éš¨æ©Ÿå¦è±¡å•ç­”ç³»çµ± ğŸ”®",
    description="è¼¸å…¥ä½ çš„å•é¡Œï¼ŒAIç®—å‘½å¸«æœƒè‡ªå‹•å¹«ä½ èµ·å¦ä¸¦è§£æå¦è±¡ã€‚"
).launch(share=True)